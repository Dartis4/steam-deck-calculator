<!DOCTYPE html>
<html>
<head>
</head>
<body>

  <div>
      1. Fill out <a href='https://forms.gle/vfU1UwU3NoYXNmiG8'>https://forms.gle/vfU1UwU3NoYXNmiG8</a> with your
    information:<br>
    <a href="https://docs.google.com/spreadsheets/d/1QqlSUpqhyBCBYeu_gW4w5vIxfcd7qablSviALDFJ0Dg/edit?usp=sharing">Link to
      spreadsheet</a><br>
    <!-- <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSfLZaRMIVknUubuHjhfXU_x6VEAifId-n7rIhi6DVTPTcLWNw/viewform?embedded=true" width="600" height="600" frameborder="0" marginheight="0" marginwidth="0">Loadingâ€¦</iframe><br> -->

    2. Model:
    <select name="Model" id="model" onchange="updateAndStore('model')">
      <option value="64">64 GB</option>
      <option value="256">256 GB</option>
      <option value="512">512 GB</option>
    </select><br>

    3. Region:
    <select name="Region" id="region" onchange="updateAndStore('region')">
      <option value="US">US</option>
      <option value="UK">UK</option>
      <option value="EU">EU</option>
    </select><br>

    3. Current Estimated Order availabilty:
    <select name="Order availabilty" id="order_avail" onchange="updateAndStore('order_avail')">
      <option value="Q1">Q1</option>
      <option value="Q2">Q2</option>
      <option value="After Q2">After Q2</option>
    </select><br>

    4. rtReserveTime (ex 1626454969):
    <input type="number" id="rtReserveTime" onchange="updateTimeDisplay()"> <span id="time_display"></span> <br>

    5. Import data<br>
    <!-- <button onclick="getData('latest.csv')">moo latest (imported never. not enough data yet)</button><br> -->
    <button onclick="getData('2-9-22-hoxeel.csv')">u/hoxeel (imported 2022-9-2)</button><br>
    <input type="file" id="file" />Upload the latest data manually. Export the spreadsheet as a CSV, then upload it here.
    
    <br><br>
    <!-- <button onclick="calculate(moo)">Calculate (moo's method)</button><br> -->
    <button onclick="calculate(gecked)">Calculate (gecked's method)</button><br>
    <br>
  </div>

  <h1 style="text-align: center;" id="results">
  Your Estimated Order Date: ???????????????<br>
  ??? day(s) ?? hour(s) ?? minute(s) ?? second(s) 
  </h1>

  <br>
  See raw data:<br>


  Include a countdown<br>


  Include a spreadsheet of region, model, and pre-order time compared to estimated order time<br>
</body>
</html>

<script>

  result = null;

  function getLocalStorageOrDefault (item) {
    const defaults = {
      region: "US",
      model: "256",
      rtReserveTime: "1626454969",
      order_avail: "Q1",
    }
    if(localStorage.getItem(item) == null) {
      return defaults[item];
    }
    return localStorage.getItem(item);
  }

  //clear file input
  document.getElementById("file").value = null;

  //Load data from local-storage
  document.getElementById('region').value = getLocalStorageOrDefault("region");
  document.getElementById('model').value = getLocalStorageOrDefault("model");
  document.getElementById('rtReserveTime').value = getLocalStorageOrDefault("rtReserveTime");
  document.getElementById('order_avail').value = getLocalStorageOrDefault("order_avail");

  //Called when a form item changes state. Stores the value into local storage for later use.
  function updateAndStore(item) {
    const value = document.getElementById(item).value;
    localStorage.setItem(item, value);
  }

  function updateTimeDisplay () {
    updateAndStore('rtReserveTime');
    const date = new Date(document.getElementById('rtReserveTime').value * 1000);
    document.getElementById('time_display').innerHTML = `${date.toDateString()} ${date.toTimeString()}`;
  }

  function customFileUpload(evt) {
    var file = evt.target.files[0]; // FileList object
    var reader = new FileReader();
    reader.readAsText(file, "UTF-8");
    reader.onload = function (evt) {
      loaded_data = dataFromCSVString(evt.target.result);
    }
  }
  document.getElementById('file').addEventListener('change', customFileUpload, false);

  updateTimeDisplay();
</script>

<script>
  //https://stackoverflow.com/questions/1293147/example-javascript-code-to-parse-csv-data
  function parseCSV(str) {
    var arr = [];
    var quote = false;  // 'true' means we're inside a quoted field

    // Iterate over each character, keep track of current row and column (of the returned array)
    for (var row = 0, col = 0, c = 0; c < str.length; c++) {
      var cc = str[c], nc = str[c + 1];        // Current character, next character
      arr[row] = arr[row] || [];             // Create a new row if necessary
      arr[row][col] = arr[row][col] || '';   // Create a new column (start with empty string) if necessary

      // If the current character is a quotation mark, and we're inside a
      // quoted field, and the next character is also a quotation mark,
      // add a quotation mark to the current column and skip the next character
      if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }

      // If it's just one quotation mark, begin/end quoted field
      if (cc == '"') { quote = !quote; continue; }

      // If it's a comma and we're not in a quoted field, move on to the next column
      if (cc == ',' && !quote) { ++col; continue; }

      // If it's a newline (CRLF) and we're not in a quoted field, skip the next character
      // and move on to the next row and move to column 0 of that new row
      if (cc == '\r' && nc == '\n' && !quote) { ++row; col = 0; ++c; continue; }

      // If it's a newline (LF or CR) and we're not in a quoted field,
      // move on to the next row and move to column 0 of that new row
      if (cc == '\n' && !quote) { ++row; col = 0; continue; }
      if (cc == '\r' && !quote) { ++row; col = 0; continue; }

      // Otherwise, append the current character to the current column
      arr[row][col] += cc;
    }
    return arr;
  }
  function dataFromCSVString (data) {
    const parsed = parseCSV(data);
    let responses = [];
    for (let i = 1; i < parsed.length; i++) {
      responses.push(new Response(parsed[i]));
    }
    return new Data(responses);
  }
</script>

<script>

  class Response {
    constructor(data) {
      this.timestamp = data[0]; //2/8/2022 15:34:25
      this.region = data[1]; //"US", "EU", "UK"
      this.model = data[2]; //"64", "256", "512"
      this.rtReserveTime = +data[3]; //preorder timestamp, number.
      this.firstValveUpdate = data[4]; //
      this.secondValveUpdate = data[5]; //
    }

    isReserveTimeAfter (other) {
      return this.rtReserveTime > other.rtReserveTime;
    }
  }

  class Data {
    constructor(responses) {
      this.responses = responses; //List of Response objects.
    }

    //Returns all responses where the model matches.
    whereModelIs(model) {
      return new Data(this.responses.filter(response => response.model === model));
    }

    //Returns all responses where the model matches.
    whereRegionIs(region) {
      return new Data(this.responses.filter(response => response.region === region));
    }

    sortByPreorderTimestamp () {
      return new Data(this.responses.sort((a, b) => b - a));
    }
  }

  function getData(url) {
    fetch(url).then(response => response.text()).then((data) => {
      loaded_data = dataFromCSVString(data)
    });
  }

  function calculate (algorythm) {
    calculate_error = undefined;
    try {
      result = algorythm({
        model: getLocalStorageOrDefault("model"),
        region: getLocalStorageOrDefault("region"),
        rtReserveTime: getLocalStorageOrDefault("rtReserveTime"),
        order_avail: getLocalStorageOrDefault("order_avail"),
      }, loaded_data);
    } catch (e) {
      console.log(e);
      calculate_error = e;
    }
    update_data();
  }

  //Do the fun stuff to display the things!
  function update_data () {
    if(calculate_error != null) {
      document.getElementById('results').innerHTML = `${calculate_error}`;
      return;
    }
    if(result !== null) {

      const date = new Date(result);
      const diff = date.getTime() - Date.now();

      document.getElementById('results').innerHTML = `
      Your Estimated Order Date: ${date.toDateString()}<br>
      ${Math.floor( diff/(1000*60*60*24) )} day(s)
      ${Math.floor( (diff/(1000*60*60)) % 24 )} hour(s)
      ${Math.floor( (diff/1000/60) % 60 )} minute(s)
      ${Math.floor( (diff/1000) % 60 )} second(s)
      <br>
      `;
    }
  }
  setInterval(update_data, 1000);


  getData('2-9-22-hoxeel.csv');
</script>




<script>
  //Moo's method for calculating
  //Should return a Date object.

  function moo(parameters, data) {
    return new Date(Date.now() + (100000 * 1000));
  }

</script>

<script>
  
  /*Original python script credit
  u/jplayzgamezevrnonsub
  Big thank you to jimmosio for helping to get the calculator and filtration code working

  THE DATES PROVIDED BY THIS CALCULATOR SHOULD NOT BE EXPECTED TO BE ACCURATE
  THIS CALCULATOR WAS MADE AS A FUN GIMMICK, NOT SOMETHING YOU SHOULD BE TAKING AS FACT!

  #If anybody is here to improve and or fix this code, feel free to credit youself. However some quick notes, please keep the original credits. 
  They are deserved and removing them would be doing a disservice to me and the other people involved in this project.
  Secondly, I know this code is probably a mess, but I'm trying my best, 
  I'm only 15 and working with what I know. Feel free to critisize it all you like, 
  but at least make what you say constructive. Lastly, if you make any fixes, and don't mind losing out of the fame a little. 
  Let me know what to change and I will implement it into the main fork, (you will be credited, of course). 
  I will also try to keep the data used by this code semi-up to date, so if you ever fork this try and do the same for the best results.
  */

  //Should return a Date object.
  function gecked(parameters, data) {
    if(parameters.order_avail == "After Q2") {
      throw "this calculator does not work for after q2 dates";
    }

    //Filter data to only include this region and model.
    const filtered = data.whereModelIs(parameters.model).whereRegionIs(parameters.region);
    
    const daysInQuarter = parameters.order_avail === "Q1" ? 34 : 91;
    const ans = daysInQuarter / (filtered.responses.length - 1);

    let userQueuePos = 0;

    let x = 0;
    let confirm = 0;
    while(confirm == 0) {
      if(parameters.rtReserveTime < filtered.responses[x].rtReserveTime && confirm == 0) {
        userQueuePos = (x + 1);
        confirm = 1;
      }
      x += 1;
    }

    userDate = daysInQuarter / filtered.responses.length;
    userDate = Math.ceil(ans * userQueuePos);

    const launchDate = new Date(1645768800 * 1000);
    const april = new Date(1648789200 * 1000);
    const millisInDay = 1000 * 60 * 60 * 24;

    if(parameters.order_avail == "Q1") {
      return new Date(launchDate.getTime() + (userDate * millisInDay));
    }
    if(parameters.order_avail == "Q2") {
      return new Date(april.getTime() + ((userDate) * millisInDay));
    }
    throw "bad state";
  }

</script>